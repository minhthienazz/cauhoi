<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>H·ªì S∆° T√¢m L√Ω - Deep Soul v9</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- CSS STYLES -->
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-gray: #8E8E93;
            --ios-text: #1C1C1E;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: var(--ios-bg);
            height: 100dvh; width: 100vw; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            margin: 0; padding: 0; color: var(--ios-text);
        }

        .app-container {
            background: var(--ios-card);
            width: 100%; height: 100%;
            display: flex; flex-direction: column; position: relative; overflow: hidden;
        }

        @media (min-width: 768px) {
            .app-container {
                width: 100%; max-width: 480px; height: 92vh; max-height: 900px;
                border-radius: 44px; box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.3);
                border: 8px solid #1a1a1a;
            }
        }

        .scroll-content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 24px 20px; padding-bottom: 140px;
            -webkit-overflow-scrolling: touch; scroll-behavior: smooth;
        }

        .footer-fixed {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.9);
            border-top: 1px solid rgba(0,0,0,0.05);
            padding: 16px 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 50;
        }

        /* UI ELEMENTS */
        .ios-input {
            background: #F2F2F7; border: none; border-radius: 12px;
            font-size: 17px; transition: all 0.2s ease;
        }
        .ios-input:focus { background: #E5E5EA; outline: none; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }
        .input-error { background: #FFF0F0 !important; box-shadow: inset 0 0 0 1px #FF3B30 !important; }

        .option-card {
            background: white; border: 1px solid #E5E5EA; border-radius: 16px;
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1); transform: translateZ(0);
        }
        .option-card:active { transform: scale(0.97); background-color: #F2F2F7; }
        
        .option-selected {
            background: #007AFF !important; border-color: #007AFF !important;
            color: white !important; box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }
        .option-selected .circle-check { border-color: white; background: rgba(255,255,255,0.3); }
        .option-selected .opt-text { color: white; font-weight: 600; }

        /* Report Styles */
        .report-section { margin-bottom: 24px; background: #fff; border-radius: 20px; padding: 20px; border: 1px solid #F2F2F7; }
        .report-header { font-size: 13px; font-weight: 700; color: #8E8E93; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px; }
        .bullet-point { display: flex; align-items: flex-start; margin-bottom: 8px; font-size: 14px; line-height: 1.5; color: #3A3A3C; }
        .bullet-point i { margin-right: 10px; margin-top: 4px; font-size: 12px; }
        
        /* Stats Bar */
        .stat-row { display: flex; align-items: center; margin-bottom: 8px; }
        .stat-label { width: 80px; font-size: 12px; font-weight: 600; color: #333; }
        .stat-track { flex: 1; height: 6px; background: #F2F2F7; border-radius: 3px; overflow: hidden; margin: 0 10px; }
        .stat-fill { height: 100%; border-radius: 3px; }
        .stat-val { width: 30px; text-align: right; font-size: 11px; font-weight: 600; color: #8E8E93; }

        /* Animation */
        @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .fade-enter { animation: fadeIn 0.5s ease-out; }

        .char-counter { font-size: 11px; font-weight: 600; color: #8E8E93; }
        input, textarea { user-select: text; }
        .ios-spinner { width: 32px; height: 32px; border: 3.5px solid rgba(0,0,0,0.1); border-top-color: #007AFF; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- SCREEN 1: WELCOME -->
        <div id="welcome-screen" class="absolute inset-0 z-50 bg-white flex flex-col h-full fade-enter">
            <div class="scroll-content flex flex-col items-center justify-center text-center">
                <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-[28px] flex items-center justify-center mb-6 shadow-xl shadow-indigo-200">
                    <i class="fas fa-fingerprint text-5xl text-white"></i>
                </div>
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">H·ªì S∆° T√¢m L√Ω</h1>
                <p class="text-gray-500 mb-8 px-4 text-[15px] font-medium">B√°o c√°o ph√¢n t√≠ch chuy√™n s√¢u v9.0<br>
                    <span id="continue-msg" class="hidden text-xs text-indigo-600 font-bold mt-2 bg-indigo-50 px-3 py-1 rounded-full"><i class="fas fa-history"></i> Kh√¥i ph·ª•c d·ªØ li·ªáu c≈©</span>
                </p>
                <div class="w-full space-y-5 text-left bg-[#F9F9FB] p-6 rounded-[24px] border border-gray-100">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-2">H·ªç t√™n</label>
                        <input type="text" id="user-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." class="ios-input w-full pl-4 pr-4 py-4 mt-1 font-semibold text-gray-900">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-2">Li√™n h·ªá</label>
                        <div class="mt-1 flex gap-2">
                            <select id="contact-type" class="ios-input w-1/3 pl-3 pr-2 py-4 font-semibold text-gray-700 bg-white border border-gray-200"><option value="SƒêT">SƒêT</option><option value="Zalo">Zalo</option><option value="Fb">Fb</option></select>
                            <input type="text" id="contact-value" placeholder="Th√¥ng tin..." class="ios-input flex-1 px-4 py-4 text-gray-900">
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer-fixed w-full">
                <button onclick="startQuiz()" class="w-full bg-[#1C1C1E] text-white font-bold py-4 rounded-2xl shadow-xl active:scale-95 transition-transform text-[16px]">B·∫Øt ƒë·∫ßu ph√¢n t√≠ch</button>
            </div>
        </div>

        <!-- SCREEN 2: QUIZ -->
        <div id="quiz-screen" class="hidden flex flex-col h-full relative bg-white">
            <div class="flex-shrink-0 px-5 py-4 bg-white/80 backdrop-blur-xl border-b border-gray-100 flex justify-between items-center z-10 sticky top-0">
                <div class="flex items-center gap-3">
                    <button id="btn-sound" onclick="toggleSound()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition"><i class="fas fa-volume-up"></i></button>
                    <div class="flex flex-col"><span class="text-[10px] font-bold text-gray-400 uppercase">·ª®ng vi√™n</span><span id="display-name" class="text-sm font-bold text-gray-900 truncate max-w-[120px]">User</span></div>
                </div>
                <div class="bg-gray-100 px-3 py-1.5 rounded-lg border border-gray-200"><span id="timer" class="text-sm font-mono font-bold">30:00</span></div>
            </div>
            <div class="w-full bg-gray-100 h-1.5 flex-shrink-0"><div id="progress-bar" class="bg-blue-600 h-1.5 rounded-r-full transition-all duration-500 ease-out" style="width: 0%"></div></div>
            
            <div class="scroll-content" id="scroll-container">
                <div class="mb-6 fade-enter">
                    <div class="flex justify-between items-end mb-3">
                        <span class="inline-block px-3 py-1 bg-blue-50 text-blue-600 text-[10px] font-bold rounded-full uppercase tracking-wider border border-blue-100" id="part-label">PH·∫¶N 1</span>
                        <span class="text-xs font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded border border-gray-100" id="question-number">1/30</span>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 leading-snug mb-2" id="question-text">...</h2>
                    <p id="question-hint" class="text-xs text-gray-500 font-medium hidden italic mt-1 flex items-center gap-1"><i class="fas fa-pen-nib"></i> <span id="hint-text"></span></p>
                </div>
                <div id="error-badge" class="hidden mb-4 p-3 bg-red-50 text-red-500 text-xs font-bold rounded-xl flex items-center gap-2 animate-shake border border-red-100"><i class="fas fa-exclamation-triangle"></i> <span id="error-text">Vui l√≤ng tr·∫£ l·ªùi</span></div>
                <div id="options-area" class="space-y-3 pb-10"></div>
            </div>

            <div class="footer-fixed flex gap-3">
                <button id="btn-prev" onclick="playSound('click'); prevQuestion()" class="w-14 h-14 rounded-2xl bg-[#F2F2F7] text-gray-500 flex items-center justify-center disabled:opacity-30 transition-all active:scale-90 shadow-sm border border-gray-200"><i class="fas fa-arrow-left"></i></button>
                <button id="btn-next" onclick="playSound('click'); nextQuestion()" class="flex-1 h-14 rounded-2xl bg-[#1C1C1E] text-white font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all text-sm">Ti·∫øp theo</button>
                <button id="btn-submit" onclick="playSound('click'); attemptSubmit()" class="hidden flex-1 h-14 rounded-2xl bg-blue-600 text-white font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all text-sm">Xem B√°o C√°o <i class="fas fa-file-alt"></i></button>
            </div>
        </div>

        <!-- SCREEN 3: LOADING -->
        <div id="loading-screen" class="hidden absolute inset-0 z-[60] bg-white/95 backdrop-blur-xl flex-col items-center justify-center">
            <div class="ios-spinner mb-6"></div>
            <h3 class="text-sm font-bold text-gray-900 uppercase tracking-widest mb-2">ƒêANG PH√ÇN T√çCH</h3>
            <p class="text-xs text-gray-500 font-medium animate-pulse">T·ªïng h·ª£p d·ªØ li·ªáu h√†nh vi...</p>
        </div>

        <!-- SCREEN 4: MASTER REPORT (NEW DESIGN) -->
        <div id="result-screen" class="hidden absolute inset-0 z-50 bg-[#F2F2F7] flex flex-col h-full overflow-hidden fade-enter">
            <div class="flex-shrink-0 px-5 py-4 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-20">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">B√ÅO C√ÅO T√ÇM L√ù</span>
                <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">CHUY√äN S√ÇU</span>
            </div>

            <div class="scroll-content pt-4 pb-24">
                <!-- 1. PROFILE HEADER -->
                <div class="report-section relative overflow-hidden text-center">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                    <div class="w-20 h-20 mx-auto bg-gray-900 rounded-full flex items-center justify-center mb-4 shadow-xl text-white text-3xl mt-2">
                        <i id="res-icon" class="fas fa-user"></i>
                    </div>
                    <h1 id="res-title" class="text-xl font-black text-gray-900 mb-1 uppercase">...</h1>
                    <p id="res-combo" class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">...</p>
                    <p id="res-desc" class="text-sm text-gray-600 leading-relaxed text-justify font-medium bg-gray-50 p-4 rounded-xl border border-gray-100">...</p>
                </div>

                <!-- 2. STATS CHART -->
                <div class="report-section">
                    <h3 class="report-header"><i class="fas fa-chart-pie text-blue-500 mr-2"></i>Bi·ªÉu ƒê·ªì Xu H∆∞·ªõng</h3>
                    <div id="stats-container"></div> <!-- Render JS -->
                </div>

                <!-- 3. DETAILED ANALYSIS (NEW) -->
                <div class="report-section">
                    <h3 class="report-header"><i class="fas fa-search text-purple-500 mr-2"></i>Ph√¢n T√≠ch Chi Ti·∫øt</h3>
                    
                    <div class="mb-4">
                        <h4 class="text-xs font-bold text-green-600 mb-2 uppercase flex items-center"><i class="fas fa-plus-circle mr-1"></i> ƒêi·ªÉm M·∫°nh</h4>
                        <div id="res-strong" class="space-y-2"></div>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="text-xs font-bold text-red-500 mb-2 uppercase flex items-center"><i class="fas fa-minus-circle mr-1"></i> ƒêi·ªÉm Y·∫øu & R·ªßi Ro</h4>
                        <div id="res-weak" class="space-y-2"></div>
                    </div>

                    <div>
                        <h4 class="text-xs font-bold text-blue-600 mb-2 uppercase flex items-center"><i class="fas fa-lightbulb mr-1"></i> L·ªùi Khuy√™n Ph√°t Tri·ªÉn</h4>
                        <div id="res-advice" class="space-y-2"></div>
                    </div>
                </div>

                <!-- 4. OPEN ANSWERS REVIEW -->
                <div class="report-section">
                    <h3 class="report-header"><i class="fas fa-book-open text-orange-500 mr-2"></i>H·ªì S∆° T·ª± Lu·∫≠n</h3>
                    <div id="open-answers-review" class="space-y-4">
                        <!-- Render JS -->
                    </div>
                </div>

                <div class="text-center text-[10px] text-gray-400 mb-4">
                    K·∫øt qu·∫£ n√†y ch·ªâ hi·ªÉn th·ªã cho b·∫°n.<br>Admin ch·ªâ nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu th√¥ ƒë·ªÉ l∆∞u tr·ªØ.
                </div>
            </div>

            <div class="footer-fixed w-full flex gap-3">
                <button onclick="clearAndReload()" class="w-full bg-white text-red-500 font-bold py-4 rounded-2xl shadow-md active:scale-95 transition-transform text-sm uppercase border border-gray-200">
                    <i class="fas fa-redo mr-2"></i> L√†m b√†i m·ªõi
                </button>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // CONFIG
        const TELEGRAM_TOKEN = "6452107579:AAHD9JfgCbnzN8c2s8mBq9beyTXA7plmnIQ"; 
        const ADMIN_CHAT_ID = "2028093357";
        const STORAGE_KEY = 'deep_soul_v9_master';

        // AUDIO
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            if (type === 'pop') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                g.gain.setValueAtTime(0.05, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.03);
                osc.start(); osc.stop(audioCtx.currentTime + 0.03);
            }
        }

        // --- FULL DATASET (UPDATED FROM PDF) ---
        const questions = [
            // MCQ (20)
            { id: 1, type: 'mcq', text: "Trong m·ªôt bu·ªïi ti·ªác ƒë√¥ng ng∆∞·ªùi, b·∫°n th∆∞·ªùng:", options: [{k:'A', v:"L√† t√¢m ƒëi·ªÉm, ch·ªß ƒë·ªông b·∫Øt chuy·ªán."}, {k:'B', v:"Ch·ªâ tr√≤ chuy·ªán s√¢u v·ªõi 1-2 ng∆∞·ªùi quen."}, {k:'C', v:"Quan s√°t t·ª´ xa v√† ph√¢n t√≠ch t√¨nh hu·ªëng."}, {k:'D', v:"C·∫£m th·∫•y mu·ªën v·ªÅ s·ªõm ho·∫∑c t√¨m kh√¥ng gian ri√™ng."}] },
            { id: 2, type: 'mcq', text: "Khi g·∫∑p m·ªôt v·∫•n ƒë·ªÅ h√≥c b√∫a t·∫°i n∆°i l√†m vi·ªác:", options: [{k:'A', v:"Ra quy·∫øt ƒë·ªãnh v√† h√†nh ƒë·ªông ngay l·∫≠p t·ª©c."}, {k:'B', v:"T√¨m ng∆∞·ªùi h·ªó tr·ª£ ho·∫∑c h·ªèi √Ω ki·∫øn t·∫≠p th·ªÉ."}, {k:'C', v:"T·ª± m√¨nh m√†y m√≤, ph√¢n t√≠ch d·ªØ li·ªáu tr∆∞·ªõc."}, {k:'D', v:"T√¨m c√°ch n√© tr√°nh ho·∫∑c l√†m vi·ªác kh√°c d·ªÖ h∆°n."}] },
            { id: 3, type: 'mcq', text: "Quan ƒëi·ªÉm v·ªÅ quy t·∫Øc v√† lu·∫≠t l·ªá?", options: [{k:'A', v:"L√† c√¥ng c·ª• ƒë·ªÉ qu·∫£n l√Ω ng∆∞·ªùi kh√°c."}, {k:'B', v:"C·∫ßn thi·∫øt ƒë·ªÉ duy tr√¨ s·ª± h√≤a h·ª£p."}, {k:'C', v:"Ph·∫£i tu√¢n th·ªß tuy·ªát ƒë·ªëi v√† ch√≠nh x√°c."}, {k:'D', v:"K√¨m h√£m s·ª± s√°ng t·∫°o v√† t·ª± do."}] },
            { id: 4, type: 'mcq', text: "Khi b·∫°n than v√£n v·ªÅ c√πng m·ªôt v·∫•n ƒë·ªÅ l·∫ßn th·ª© 10:", options: [{k:'A', v:"Th·∫≥ng th·∫Øn ch·ªâ ra l·ªói sai ƒë·ªÉ s·ª≠a."}, {k:'B', v:"V·∫´n ki√™n nh·∫´n l·∫Øng nghe v√† an ·ªßi."}, {k:'C', v:"ƒê∆∞a ra gi·∫£i ph√°p logic d·ª©t ƒëi·ªÉm."}, {k:'D', v:"L·∫£ng sang chuy·ªán kh√°c vui h∆°n."}] },
            { id: 5, type: 'mcq', text: "K·ª≥ ngh·ªâ l√Ω t∆∞·ªüng c·ªßa b·∫°n?", options: [{k:'A', v:"Th√°m hi·ªÉm, chinh ph·ª•c th·ª≠ th√°ch."}, {k:'B', v:"Ngh·ªâ d∆∞·ª°ng b√™n gia ƒë√¨nh, ng∆∞·ªùi th√¢n."}, {k:'C', v:"Tham quan di t√≠ch l·ªãch s·ª≠, vƒÉn h√≥a."}, {k:'D', v:"ƒêi ph∆∞·ª£t t·ª± do, kh√¥ng k·∫ø ho·∫°ch."}] },
            { id: 6, type: 'mcq', text: "C∆° s·ªü ƒë∆∞a ra quy·∫øt ƒë·ªãnh quan tr·ªçng?", options: [{k:'A', v:"M·ª•c ti√™u v√† k·∫øt qu·∫£ ƒë·∫°t ƒë∆∞·ª£c."}, {k:'B', v:"C·∫£m x√∫c v√† t√°c ƒë·ªông ƒë·∫øn m·ªçi ng∆∞·ªùi."}, {k:'C', v:"S·ªë li·ªáu, b·∫±ng ch·ª©ng th·ª±c t·∫ø."}, {k:'D', v:"Tr·ª±c gi√°c v√† h·ª©ng th√∫ nh·∫•t th·ªùi."}] },
            { id: 7, type: 'mcq', text: "B·∫°n th·∫•y m√¨nh l√† ng∆∞·ªùi:", options: [{k:'A', v:"H∆∞·ªõng t·ªõi t∆∞∆°ng lai v√† tham v·ªçng."}, {k:'B', v:"S·ªëng v√¨ ng∆∞·ªùi kh√°c v√† t√¨nh c·∫£m."}, {k:'C', v:"C·∫©n tr·ªçng v√† th·ª±c t·∫ø."}, {k:'D', v:"S·ªëng cho hi·ªán t·∫°i v√† tr·∫£i nghi·ªám."}] },
            { id: 8, type: 'mcq', text: "M·ª•c ti√™u trong tranh lu·∫≠n?", options: [{k:'A', v:"Chi·∫øn th·∫Øng v√† kh·∫≥ng ƒë·ªãnh v·ªã th·∫ø."}, {k:'B', v:"Gi·ªØ h√≤a kh√≠, tr√°nh xung ƒë·ªôt."}, {k:'C', v:"T√¨m ra ch√¢n l√Ω ƒë√∫ng sai r√µ r√†ng."}, {k:'D', v:"Thuy·∫øt ph·ª•c ng∆∞·ªùi kh√°c theo √Ω m√¨nh."}] },
            { id: 9, type: 'mcq', text: "Suy nghƒ© khi th·∫•y ng∆∞·ªùi ƒÉn xin?", options: [{k:'A', v:"T·∫°i sao h·ªç kh√¥ng n·ªó l·ª±c l√†m vi·ªác?"}, {k:'B', v:"T·ªôi nghi·ªáp, c·∫ßn gi√∫p ƒë·ª° h·ªç."}, {k:'C', v:"C√≥ khi n√†o l√† l·ª´a ƒë·∫£o kh√¥ng?"}, {k:'D', v:"L∆∞·ªõt qua, ai c≈©ng c√≥ s·ªë ph·∫≠n ri√™ng."}] },
            { id: 10, type: 'mcq', text: "Kh√¥ng gian l√†m vi·ªác c·ªßa b·∫°n?", options: [{k:'A', v:"Sang tr·ªçng, th·ªÉ hi·ªán quy·ªÅn l·ª±c."}, {k:'B', v:"·∫§m c√∫ng, c√≥ ·∫£nh ng∆∞·ªùi th√¢n."}, {k:'C', v:"G·ªçn g√†ng, ngƒÉn n·∫Øp, khoa h·ªçc."}, {k:'D', v:"ƒê·ªôc ƒë√°o, ph√° c√°ch, l·ªôn x·ªôn."}] },
            { id: 11, type: 'mcq', text: "N·∫øu tr√∫ng s·ªë 10 t·ª∑, b·∫°n l√†m g√¨?", options: [{k:'A', v:"ƒê·∫ßu t∆∞ l·ªõn ho·∫∑c mua ƒë·ªì xa x·ªâ."}, {k:'B', v:"Chia s·∫ª cho gia ƒë√¨nh, t·ª´ thi·ªán."}, {k:'C', v:"G·ª≠i ti·∫øt ki·ªám, t√≠nh to√°n k·ªπ l∆∞·ª°ng."}, {k:'D', v:"ƒêi du l·ªãch v√≤ng quanh th·∫ø gi·ªõi."}] },
            { id: 12, type: 'mcq', text: "N·ªói s·ª£ l·ªõn nh·∫•t?", options: [{k:'A', v:"Th·∫•t b·∫°i, m·∫•t m·∫∑t, b·ªã coi th∆∞·ªùng."}, {k:'B', v:"C√¥ ƒë∆°n, b·ªã m·ªçi ng∆∞·ªùi xa l√°nh."}, {k:'C', v:"Sai l·∫ßm, h·ªón lo·∫°n, thi·∫øu ki·ªÉm so√°t."}, {k:'D', v:"B·ªã r√†ng bu·ªôc, m·∫•t t·ª± do."}] },
            { id: 13, type: 'mcq', text: "Ph·∫£n ·ª©ng khi xem phim bu·ªìn?", options: [{k:'A', v:"Kh√≥ ch·ªãu n·∫øu nh√¢n v·∫≠t y·∫øu ƒëu·ªëi."}, {k:'B', v:"Kh√≥c ngon l√†nh, ƒë·ªìng c·∫£m s√¢u s·∫Øc."}, {k:'C', v:"Ph√¢n t√≠ch k·ªãch b·∫£n v√† di·ªÖn xu·∫•t."}, {k:'D', v:"Th·∫•y b√¨nh th∆∞·ªùng, phim th√¥i m√†."}] },
            { id: 14, type: 'mcq', text: "B·∫°n c√≥ hay tr·ªÖ h·∫πn kh√¥ng?", options: [{k:'A', v:"Kh√¥ng, t√¥i gh√©t s·ª± ch·∫≠m tr·ªÖ."}, {k:'B', v:"Th·ªânh tho·∫£ng, n·∫øu b·∫≠n gi√∫p ai ƒë√≥."}, {k:'C', v:"Kh√¥ng bao gi·ªù, t√¥i lu√¥n ƒë·∫øn s·ªõm."}, {k:'D', v:"Th∆∞·ªùng xuy√™n, t√¥i hay qu√™n gi·ªù."}] },
            { id: 15, type: 'mcq', text: "Ng∆∞·ªùi kh√°c ƒë√°nh gi√° b·∫°n th·∫ø n√†o?", options: [{k:'A', v:"M·∫°nh m·∫Ω, l√£nh ƒë·∫°o, h∆°i √°p ƒë·∫∑t."}, {k:'B', v:"Th√¢n thi·ªán, t·ªët b·ª•ng, d·ªÖ m·∫øn."}, {k:'C', v:"Th√¥ng minh, chi ti·∫øt, kh√≥ t√≠nh."}, {k:'D', v:"Vui v·∫ª, s√°ng t·∫°o, h∆°i l·∫≠p d·ªã."}] },
            { id: 16, type: 'mcq', text: "Khi t·ª©c gi·∫≠n t·ªôt ƒë·ªô?", options: [{k:'A', v:"B√πng n·ªï, la h√©t, ƒë·∫≠p ƒë·ªì."}, {k:'B', v:"Kh√≥c l√≥c, bu·ªìn b√£, im l·∫∑ng."}, {k:'C', v:"L·∫°nh l√πng, n√≥i l√Ω l·∫Ω s·∫Øc b√©n."}, {k:'D', v:"Ch√¢m ch·ªçc, m·ªâa mai, b·ªè ƒëi."}] },
            { id: 17, type: 'mcq', text: "Quan ƒëi·ªÉm v·ªÅ s·ª± thay ƒë·ªïi?", options: [{k:'A', v:"Th√≠ch, ƒë√≥ l√† c∆° h·ªôi ƒë·ªÉ ti·∫øn l√™n."}, {k:'B', v:"Lo l·∫Øng, th√≠ch s·ª± ·ªïn ƒë·ªãnh h∆°n."}, {k:'C', v:"Ch·∫•p nh·∫≠n n·∫øu c√≥ k·∫ø ho·∫°ch tr∆∞·ªõc."}, {k:'D', v:"R·∫•t th√≠ch, gh√©t s·ª± nh√†m ch√°n."}] },
            { id: 18, type: 'mcq', text: "So s√°nh b·∫£n th√¢n tr√™n MXH?", options: [{k:'A', v:"Th·∫•y ghen t·ªã n·∫øu h·ªç th√†nh c√¥ng h∆°n."}, {k:'B', v:"Vui m·ª´ng cho h·∫°nh ph√∫c c·ªßa h·ªç."}, {k:'C', v:"Ph√¢n t√≠ch xem h·ªç l√†m th·∫ø n√†o."}, {k:'D', v:"Kh√¥ng quan t√¢m, t√¥i s·ªëng ƒë·ªùi t√¥i."}] },
            { id: 19, type: 'mcq', text: "NƒÉng l∆∞·ª£ng c·ªßa b·∫°n gi·ªëng h√¨nh ·∫£nh n√†o?", options: [{k:'A', v:"Ng·ªçn L·ª≠a (Nhi·ªát huy·∫øt, thi√™u ƒë·ªët)."}, {k:'B', v:"D√≤ng N∆∞·ªõc (√äm ƒë·ªÅm, s√¢u l·∫Øng)."}, {k:'C', v:"T·∫£ng ƒê√° (V·ªØng ch√£i, c·ª©ng r·∫Øn)."}, {k:'D', v:"C∆°n Gi√≥ (T·ª± do, hay thay ƒë·ªïi)."}] },
            { id: 20, type: 'mcq', text: "C√¢u ch√¢m ng√¥n h·ª£p v·ªõi b·∫°n nh·∫•t?", options: [{k:'A', v:"Kh√¥ng c√≥ g√¨ l√† kh√¥ng th·ªÉ."}, {k:'B', v:"S·ªëng l√† ƒë·ªÉ y√™u th∆∞∆°ng."}, {k:'C', v:"Ch·∫≠m m√† ch·∫Øc."}, {k:'D', v:"YOLO - B·∫°n ch·ªâ s·ªëng m·ªôt l·∫ßn."}] },
            // OPEN (10) - WITH CATEGORY
            { id: 21, type: 'open', text: "N·∫øu quay v·ªÅ tu·ªïi th∆°, b·∫°n s·∫Ω n√≥i g√¨ v·ªõi ch√≠nh m√¨nh l√∫c nh·ªè?", category: "ƒê·ª®A TR·∫∫ B√äN TRONG & H·ªêI TI·∫æC", placeholder: "T√¥i s·∫Ω n√≥i...", min: 10, max: 300 },
            { id: 22, type: 'open', text: "3 ƒëi·ªÅu quan tr·ªçng nh·∫•t cu·ªôc ƒë·ªùi m√† n·∫øu thi·∫øu, b·∫°n th·∫•y v√¥ nghƒ©a?", category: "H·ªÜ TH·ªêNG GI√Å TR·ªä C·ªêT L√ïI", placeholder: "1... 2... 3...", min: 10, max: 200 },
            { id: 23, type: 'open', text: "M√¥ t·∫£ b·∫£n th√¢n b·∫±ng 3 t·ª´ t√≠ch c·ª±c v√† 3 t·ª´ ti√™u c·ª±c.", category: "T·ª∞ NH·∫¨N TH·ª®C", placeholder: "T√≠ch c·ª±c: ... \nTi√™u c·ª±c: ...", min: 10, max: 200 },
            { id: 24, type: 'open', text: "S·∫Øp x·∫øp 5 con v·∫≠t sau theo th·ª© t·ª± TH√çCH NH·∫§T: B√≤, H·ªï, C·ª´u, Ng·ª±a, L·ª£n.", category: "∆ØU TI√äN V√î TH·ª®C", placeholder: "Th·ª© t·ª±: ...", min: 5, max: 150 },
            { id: 25, type: 'open', text: "N·∫øu ng√†y mai m·∫•t gi·ªçng n√≥i vƒ©nh vi·ªÖn, c√¢u cu·ªëi c√πng b·∫°n n√≥i l√† g√¨?", category: "TH√îNG ƒêI·ªÜP CH∆ØA N√ìI", placeholder: "T√¥i s·∫Ω n√≥i...", min: 5, max: 200 },
            { id: 26, type: 'open', text: "H√£y m√¥ t·∫£ m·ªôt ng√†y ho√†n h·∫£o ƒë·ªëi v·ªõi b·∫°n.", category: "ƒê·ªäNH NGHƒ®A H·∫†NH PH√öC", placeholder: "S√°ng th·ª©c d·∫≠y...", min: 20, max: 400 },
            { id: 27, type: 'open', text: "Khi bu·ªìn, b·∫°n th∆∞·ªùng l√†m g√¨ ƒë·ªÉ t·ª± an ·ªßi?", category: "C∆† CH·∫æ T·ª∞ CH·ªÆA L√ÄNH", placeholder: "T√¥i th∆∞·ªùng...", min: 10, max: 200 },
            { id: 28, type: 'open', text: "N∆°i n√†o khi·∫øn b·∫°n c·∫£m th·∫•y an to√†n v√† b√¨nh y√™n nh·∫•t?", category: "CH·ªêN TR√ö ·∫®N T√ÇM H·ªíN", placeholder: "ƒê√≥ l√†...", min: 5, max: 200 },
            { id: 29, type: 'open', text: "N·∫øu c·∫£m x√∫c hi·ªán t·∫°i l√† m·ªôt lo·∫°i th·ªùi ti·∫øt, ƒë√≥ s·∫Ω l√† g√¨?", category: "TR·∫†NG TH√ÅI HI·ªÜN T·∫†I", placeholder: "Gi·ªëng nh∆∞...", min: 5, max: 150 },
            { id: 30, type: 'open', text: "Vi·∫øt m·ªôt d√≤ng tin nh·∫Øn g·ª≠i cho ch√≠nh b·∫°n trong 5 nƒÉm t·ªõi.", category: "T·∫¶M NH√åN T∆Ø∆†NG LAI", placeholder: "G·ª≠i t√¥i...", min: 15, max: 300 }
        ];

        // --- ANALYSIS DATA (RICH CONTENT FROM PDF) ---
        const archetypes = {
            'A': { 
                title: "NG∆Ø·ªúI TH·ª¶ Lƒ®NH / H√ÄNH ƒê·ªòNG", 
                icon: "fa-chess-king", color: "text-red-500",
                desc: "B·∫°n thu·ªôc nh√≥m Dominance. B·∫°n m·∫°nh m·∫Ω, quy·∫øt ƒëo√°n v√† th√≠ch ki·ªÉm so√°t. B·∫°n coi tr·ªçng k·∫øt qu·∫£ h∆°n c·∫£m x√∫c v√† s·∫µn s√†ng ch·∫•p nh·∫≠n r·ªßi ro. B·∫°n c√≥ t·ªë ch·∫•t l√£nh ƒë·∫°o b·∫©m sinh nh∆∞ng ƒë√¥i khi c√≥ th·ªÉ h∆°i √°p ƒë·∫∑t.",
                strong: ["Quy·∫øt ƒëo√°n, kh√¥ng dao ƒë·ªông.", "Hi·ªáu su·∫•t c√¥ng vi·ªác cao.", "D≈©ng c·∫£m ƒë∆∞∆°ng ƒë·∫ßu th·ª≠ th√°ch.", "ƒê·ªôc l·∫≠p m·∫°nh m·∫Ω."],
                weak: ["C·ª©ng r·∫Øn, thi·∫øu linh ho·∫°t.", "D·ªÖ xem th∆∞·ªùng c·∫£m x√∫c ng∆∞·ªùi kh√°c.", "Kh√≥ nghe l·ªùi khuy√™n.", "D·ªÖ r∆°i v√†o c·ª±c ƒëoan th·∫Øng-thua."],
                advice: ["H·ªçc c√°ch l·∫Øng nghe v√† th·∫•u hi·ªÉu.", "Ch·∫≠m l·∫°i m·ªôt nh·ªãp tr∆∞·ªõc khi ra l·ªánh.", "Quan t√¢m ƒë·∫øn c·∫£m x√∫c c·ªßa ƒë·ªìng ƒë·ªôi."]
            },
            'B': { 
                title: "NG∆Ø·ªúI CHƒÇM S√ìC / H√íA GI·∫¢I", 
                icon: "fa-hand-holding-heart", color: "text-green-600",
                desc: "B·∫°n thu·ªôc nh√≥m Influence. B·∫°n √¥n h√≤a, s√¢u s·∫Øc v√† r·∫•t tr·ªçng t√¨nh c·∫£m. B·∫°n l·∫Øng nghe nhi·ªÅu h∆°n n√≥i v√† lu√¥n ƒë·∫∑t l·ª£i √≠ch ng∆∞·ªùi kh√°c l√™n tr√™n. B·∫°n l√† ng∆∞·ªùi gi·ªØ h√≤a kh√≠ tuy·ªát v·ªùi.",
                strong: ["X√¢y d·ª±ng quan h·ªá t·ªët, ƒë∆∞·ª£c y√™u m·∫øn.", "Nh·∫°y c·∫£m v·ªõi nhu c·∫ßu ng∆∞·ªùi kh√°c.", "T·ªët b·ª•ng, ƒë√°ng tin c·∫≠y.", "Kh·∫£ nƒÉng an ·ªßi xu·∫•t s·∫Øc."],
                weak: ["D·ªÖ ki·ªát s·ª©c v√¨ lo cho ng∆∞·ªùi kh√°c.", "Kh√≥ t·ª´ ch·ªëi, d·ªÖ b·ªã l·ª£i d·ª•ng.", "Hay t·ª± tr√°ch b·∫£n th√¢n.", "S·ª£ xung ƒë·ªôt, nh∆∞·ªùng nh·ªãn th√°i qu√°."],
                advice: ["H·ªçc c√°ch n√≥i 'KH√îNG' v√† ƒë·∫∑t ranh gi·ªõi.", "Y√™u th∆∞∆°ng b·∫£n th√¢n tr∆∞·ªõc khi y√™u ng∆∞·ªùi kh√°c.", "D√°m b√†y t·ªè quan ƒëi·ªÉm c√° nh√¢n."]
            },
            'C': { 
                title: "NG∆Ø·ªúI PH√ÇN T√çCH / LOGIC", 
                icon: "fa-brain", color: "text-blue-500",
                desc: "B·∫°n thu·ªôc nh√≥m Conscientiousness. B·∫°n s·ªëng b·∫±ng l√Ω tr√≠, d·ªØ li·ªáu v√† s·ª± chu·∫©n b·ªã. B·∫°n c·∫ßu to√†n, c·∫©n th·∫≠n v√† suy nghƒ© s√¢u s·∫Øc. B·∫°n r·∫•t ƒë√°ng tin c·∫≠y trong c√¥ng vi·ªác ƒë√≤i h·ªèi s·ª± ch√≠nh x√°c.",
                strong: ["T∆∞ duy ph√¢n t√≠ch s√¢u s·∫Øc.", "Ch·∫•t l∆∞·ª£ng c√¥ng vi·ªác ho√†n h·∫£o.", "Trung th·ª±c, kh√¥ng n√≥i d·ªëi.", "Lu√¥n c√≥ k·∫ø ho·∫°ch d·ª± ph√≤ng."],
                weak: ["C·∫ßu to√†n th√°i qu√° d·∫´n ƒë·∫øn lo √¢u.", "B·ªè l·ª° c∆° h·ªôi v√¨ t√≠nh to√°n qu√° l√¢u.", "Kh√©p k√≠n, kh√≥ tin t∆∞·ªüng ng∆∞·ªùi kh√°c.", "Hay ƒëa nghi."],
                advice: ["H√†nh ƒë·ªông ngay c·∫£ khi ch∆∞a ho√†n h·∫£o.", "M·ªü l√≤ng v√† tin t∆∞·ªüng h∆°n.", "Ch·∫•p nh·∫≠n r·ªßi ro nh∆∞ m·ªôt ph·∫ßn cu·ªôc s·ªëng."]
            },
            'D': { 
                title: "NG∆Ø·ªúI T·ª∞ DO / NGH·ªÜ Sƒ®", 
                icon: "fa-wind", color: "text-yellow-500",
                desc: "B·∫°n thu·ªôc nh√≥m Openness. B·∫°n ph√≥ng kho√°ng, s√°ng t·∫°o v√† gh√©t s·ª± g√≤ b√≥. B·∫°n s·ªëng theo c·∫£m x√∫c v√† tr·ª±c gi√°c, mang l·∫°i s·ª± m·ªõi m·∫ª. Tuy nhi√™n, b·∫°n c≈©ng d·ªÖ thay ƒë·ªïi v√† kh√≥ n·∫Øm b·∫Øt.",
                strong: ["S√°ng t·∫°o kh√¥ng gi·ªõi h·∫°n.", "Linh ho·∫°t, th√≠ch nghi nhanh.", "Mang l·∫°i ni·ªÅm vui v√† nƒÉng l∆∞·ª£ng m·ªõi.", "D√°m nghƒ© kh√°c, l√†m kh√°c."],
                weak: ["Thi·∫øu ·ªïn ƒë·ªãnh, c·∫£ th√®m ch√≥ng ch√°n.", "Kh√≥ cam k·∫øt l√¢u d√†i.", "V√¥ k·ª∑ lu·∫≠t, t√πy h·ª©ng.", "Kh√≥ ho√†n th√†nh vi·ªác d·ªü dang."],
                advice: ["R√®n luy·ªán t√≠nh k·ª∑ lu·∫≠t t·ª± gi√°c.", "Cam k·∫øt v·ªõi m·ª•c ti√™u ƒë·∫øn c√πng.", "H·ªçc c√°ch ki√™n nh·∫´n."]
            }
        };

        const combinations = {
            'AB': "L√£nh ƒê·∫°o Nh√¢n √Åi (V·ª´a quy·∫øt ƒëo√°n v·ª´a bi·∫øt quan t√¢m)",
            'AC': "L√£nh ƒê·∫°o L√Ω Tr√≠ (Quy·∫øt ƒëo√°n k·∫øt h·ª£p v·ªõi s·ª± c·∫©n tr·ªçng)",
            'AD': "Doanh Nh√¢n M·∫°o Hi·ªÉm (D≈©ng c·∫£m v√† ƒë·∫ßy s√°ng t·∫°o)",
            'BC': "T∆∞ V·∫•n Vi√™n T·∫≠n T√¢m (Quan t√¢m s√¢u s·∫Øc v√† chuy√™n m√¥n cao)",
            'BD': "Ng∆∞·ªùi B·∫°n Ch√¢n Th√†nh (Chu ƒë√°o v√† ƒë·∫ßy l√≤ng tr·∫Øc ·∫©n)",
            'CD': "Nh√† S√°ng T·∫°o L·∫≠p D·ªã (S√°ng t·∫°o nh∆∞ng c√≥ t√≠nh to√°n k·ªπ l∆∞·ª°ng)"
        };

        // VARS
        let currentStep = 0, userAnswers = {}, userName = "", userContactInfo = "", timeLeft = 30*60, timerInterval, isSoundOn = true;

        // LOAD
        window.onload = function() {
            const data = localStorage.getItem(STORAGE_KEY);
            if(data) {
                try {
                    const parsed = JSON.parse(data);
                    userName = parsed.userName||""; userContactInfo = parsed.userContactInfo||""; userAnswers = parsed.userAnswers||{}; currentStep = parsed.currentStep||0;
                    document.getElementById('user-name').value = userName;
                    if(userContactInfo) { const parts=userContactInfo.split(': '); if(parts.length>1) { document.getElementById('contact-type').value=parts[0]; document.getElementById('contact-value').value=parts[1]; } }
                    if(userName) document.getElementById('continue-msg').classList.remove('hidden');
                } catch(e) { localStorage.removeItem(STORAGE_KEY); }
            }
        };
        function saveProgress() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ userName, userContactInfo, userAnswers, currentStep })); }

        // APP FLOW
        function startQuiz() {
            playSound('click');
            const name = document.getElementById('user-name').value.trim();
            const cType = document.getElementById('contact-type').value, cVal = document.getElementById('contact-value').value.trim();
            if(!name) { document.getElementById('user-name').classList.add('input-error','animate-shake'); setTimeout(()=>document.getElementById('user-name').classList.remove('animate-shake'),500); return; }
            if(cVal && !((cType==='SƒêT'||cType==='Zalo') ? /^(0\d{9})$/.test(cVal) : cVal.length>2)) { document.getElementById('contact-value').classList.add('input-error','animate-shake'); setTimeout(()=>document.getElementById('contact-value').classList.remove('animate-shake'),500); return; }
            
            userName = name; userContactInfo = cVal ? `${cType}: ${cVal}` : "Kh√¥ng";
            document.getElementById('display-name').textContent = userName;
            if(isSoundOn) window.speechSynthesis.speak(new SpeechSynthesisUtterance(''));
            
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('quiz-screen').classList.add('flex');
            renderQuestion(); startTimer(); saveProgress();
        }

        function toggleSound() { isSoundOn=!isSoundOn; document.getElementById('btn-sound').innerHTML=isSoundOn?'<i class="fas fa-volume-up"></i>':'<i class="fas fa-volume-mute"></i>'; document.getElementById('btn-sound').classList.toggle('text-blue-600'); if(isSoundOn) speakText(questions[currentStep].text); else window.speechSynthesis.cancel(); }
        function speakText(t) { if(!isSoundOn)return; window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang='vi-VN'; window.speechSynthesis.speak(u); }
        function startTimer() { timerInterval=setInterval(()=>{ timeLeft--; const m=Math.floor(timeLeft/60), s=timeLeft%60; document.getElementById('timer').textContent=`${m}:${s<10?'0'+s:s}`; if(timeLeft<=0) submitQuiz(); },1000); }

        function renderQuestion() {
            const q = questions[currentStep];
            const area = document.getElementById('options-area');
            area.innerHTML = ''; area.className="space-y-3 pb-10";
            document.getElementById('error-badge').classList.add('hidden');
            
            document.getElementById('question-number').textContent = `${currentStep+1}/${questions.length}`;
            document.getElementById('question-text').textContent = q.text;
            document.getElementById('progress-bar').style.width = `${(currentStep/questions.length)*100}%`;
            speakText(q.text);

            if(q.type === 'mcq') {
                document.getElementById('part-label').textContent = "PH·∫¶N 1: TR·∫ÆC NGHI·ªÜM";
                document.getElementById('part-label').className="inline-block px-3 py-1 bg-blue-50 text-blue-600 text-[10px] font-bold rounded-full uppercase tracking-wider border border-blue-100";
                document.getElementById('question-hint').classList.add('hidden');
                q.options.forEach(opt => {
                    const sel = userAnswers[q.id] === opt.k;
                    const el = document.createElement('div');
                    el.className = `option-card p-4 cursor-pointer flex items-center gap-4 ${sel?'option-selected':''}`;
                    el.onclick = () => { playSound('pop'); userAnswers[q.id]=opt.k; saveProgress(); renderQuestion(); setTimeout(nextQuestion,400); };
                    el.innerHTML = `<div class="circle-check w-6 h-6 rounded-full border flex items-center justify-center flex-shrink-0 bg-white transition-all ${sel?'border-transparent':'border-gray-200'}">${sel?'<i class="fas fa-check text-blue-600 text-xs"></i>':'<span class="text-[10px] font-bold text-gray-400">'+opt.k+'</span>'}</div><span class="opt-text text-[15px] font-medium leading-relaxed text-gray-700 flex-1">${opt.v}</span>`;
                    area.appendChild(el);
                });
            } else {
                document.getElementById('part-label').textContent = "PH·∫¶N 2: T·ª∞ LU·∫¨N";
                document.getElementById('part-label').className="inline-block px-3 py-1 bg-purple-50 text-purple-600 text-[10px] font-bold rounded-full uppercase tracking-wider border border-purple-100";
                document.getElementById('question-hint').classList.remove('hidden');
                document.getElementById('hint-text').textContent = `Ch·ªß ƒë·ªÅ: ${q.category} (${q.min}-${q.max} k√Ω t·ª±)`;
                const wrp = document.createElement('div');
                wrp.innerHTML = `<textarea id="open-ans" maxlength="${q.max}" class="ios-input w-full p-4 h-48 resize-none text-sm leading-relaxed text-gray-800 border-2 border-transparent focus:border-blue-200" placeholder="${q.placeholder}"></textarea><div class="text-right mt-2"><span id="char-count" class="char-counter">0/${q.max}</span></div>`;
                area.appendChild(wrp);
                const txt = wrp.querySelector('textarea');
                txt.value = userAnswers[q.id]||"";
                const cnt = wrp.querySelector('#char-count');
                updateChar(txt, cnt, q.min, q.max);
                txt.oninput = (e) => { userAnswers[q.id]=e.target.value; updateChar(e.target, cnt, q.min, q.max); saveProgress(); };
            }
            updateButtons();
        }

        function updateChar(input, el, min, max) {
            const l = input.value.length; el.textContent=`${l}/${max}`;
            el.className = l<min ? "char-counter text-red-500" : "char-counter text-green-600";
        }

        function updateButtons() {
            document.getElementById('btn-prev').disabled = currentStep === 0;
            const isLast = currentStep === questions.length-1;
            document.getElementById('btn-next').classList.toggle('hidden', isLast);
            document.getElementById('btn-submit').classList.toggle('hidden', !isLast);
            document.getElementById('btn-submit').classList.toggle('flex', isLast);
        }

        function nextQuestion() {
            const q = questions[currentStep]; const ans = userAnswers[q.id]||"";
            if(q.type==='mcq' && !ans) return showError("Vui l√≤ng ch·ªçn ƒë√°p √°n");
            if(q.type==='open' && ans.length<q.min) return showError(`T·ªëi thi·ªÉu ${q.min} k√Ω t·ª±`);
            if(currentStep<questions.length-1) { currentStep++; renderQuestion(); }
        }
        function prevQuestion() { if(currentStep>0) { currentStep--; renderQuestion(); } }
        function attemptSubmit() {
            const q = questions[currentStep], ans = userAnswers[q.id]||"";
            if(q.type==='open' && ans.length<q.min) return showError(`T·ªëi thi·ªÉu ${q.min} k√Ω t·ª±`);
            submitQuiz();
        }
        function showError(msg) {
            const b = document.getElementById('error-badge'); b.classList.remove('hidden');
            document.getElementById('error-text').textContent = msg;
            b.classList.add('animate-shake'); setTimeout(()=>b.classList.remove('animate-shake'),500);
        }

        async function submitQuiz() {
            clearInterval(timerInterval); window.speechSynthesis.cancel();
            document.getElementById('quiz-screen').classList.add('hidden'); document.getElementById('quiz-screen').classList.remove('flex');
            document.getElementById('loading-screen').classList.remove('hidden'); document.getElementById('loading-screen').classList.add('flex');

            try {
                // 1. ANALYZE DATA
                let counts = {A:0, B:0, C:0, D:0};
                let totalMCQ = 0;
                let openAnswersHTML = "";

                questions.forEach(q => {
                    const ans = userAnswers[q.id];
                    if(q.type === 'mcq') {
                        if(ans) { counts[ans]++; totalMCQ++; }
                    } else {
                        // Build Open Answers Report HTML
                        openAnswersHTML += `
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">${q.category}</div>
                                <div class="text-xs font-bold text-gray-800 mb-2">${q.text}</div>
                                <div class="text-sm text-gray-600 italic bg-white p-3 rounded-lg border border-dashed border-gray-200">"${escapeHtml(ans)}"</div>
                            </div>
                        `;
                    }
                });

                // Calculate Percentages
                const pctA = Math.round((counts.A/totalMCQ)*100)||0;
                const pctB = Math.round((counts.B/totalMCQ)*100)||0;
                const pctC = Math.round((counts.C/totalMCQ)*100)||0;
                const pctD = Math.round((counts.D/totalMCQ)*100)||0;

                // Determine Main/Sub Types
                const sorted = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
                const main = sorted[0]; const sub = sorted[1];
                const comboKey = [main, sub].sort().join('');
                let comboText = combinations[comboKey] || "ƒê·ªôc l·∫≠p";
                if(counts[sub] < 3) comboText = `Thu·∫ßn ${main}`;

                const data = archetypes[main];

                // 2. SEND TO TELEGRAM (RAW ONLY)
                const now = new Date().toLocaleString('vi-VN');
                let msg = `<b>üìù H·ªí S∆† M·ªöI (v9.0)</b>\n‚è∞ ${now}\nüë§ ${userName} (${userContactInfo})\n\n`;
                questions.forEach((q,i) => {
                    const a = userAnswers[q.id];
                    if(q.type==='mcq') msg += `<b>C${i+1}:</b> ${a}\n`;
                    else msg += `<b>C${i+1} [${q.category}]:</b> ${a}\n\n`;
                });
                await sendTelegramMessage(msg);

                // 3. RENDER DETAILED REPORT (CLIENT SIDE)
                document.getElementById('res-icon').className = `fas ${data.icon}`;
                document.getElementById('res-title').textContent = data.title;
                document.getElementById('res-combo').textContent = comboText;
                document.getElementById('res-desc').textContent = data.desc;

                // Render Strong/Weak/Advice lists
                const createList = (items, color) => items.map(i => `<div class="bullet-point"><i class="fas fa-circle text-${color}-500"></i><span>${i}</span></div>`).join('');
                document.getElementById('res-strong').innerHTML = createList(data.strong, 'green');
                document.getElementById('res-weak').innerHTML = createList(data.weak, 'red');
                document.getElementById('res-advice').innerHTML = createList(data.advice, 'blue');

                // Render Charts
                document.getElementById('stats-container').innerHTML = `
                    <div class="stat-row"><span class="stat-label text-red-500">Th·ªß Lƒ©nh</span><div class="stat-track"><div class="stat-fill bg-red-500" style="width:${pctA}%"></div></div><span class="stat-val">${pctA}%</span></div>
                    <div class="stat-row"><span class="stat-label text-green-600">ChƒÉm S√≥c</span><div class="stat-track"><div class="stat-fill bg-green-500" style="width:${pctB}%"></div></div><span class="stat-val">${pctB}%</span></div>
                    <div class="stat-row"><span class="stat-label text-blue-500">Ph√¢n T√≠ch</span><div class="stat-track"><div class="stat-fill bg-blue-500" style="width:${pctC}%"></div></div><span class="stat-val">${pctC}%</span></div>
                    <div class="stat-row"><span class="stat-label text-yellow-500">T·ª± Do</span><div class="stat-track"><div class="stat-fill bg-yellow-500" style="width:${pctD}%"></div></div><span class="stat-val">${pctD}%</span></div>
                `;

                // Render Open Answers
                document.getElementById('open-answers-review').innerHTML = openAnswersHTML;

                playSound('pop'); localStorage.removeItem(STORAGE_KEY);
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('result-screen').classList.remove('hidden');
                    document.getElementById('result-screen').classList.add('flex');
                }, 1500);

            } catch(e) {
                alert('L·ªói k·∫øt n·ªëi m·∫°ng!');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');
                document.getElementById('quiz-screen').classList.add('flex');
            }
        }

        async function sendTelegramMessage(text) {
            const MAX = 4000;
            while(text.length > 0) {
                let chunk = text.length > MAX ? text.substring(0, text.lastIndexOf('\n', MAX)) : text;
                if(!chunk) chunk = text.substring(0, MAX);
                await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: chunk, parse_mode: 'HTML' })
                });
                text = text.substring(chunk.length);
            }
        }

        function escapeHtml(text) { return (text||"").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function clearAndReload() { localStorage.removeItem(STORAGE_KEY); location.reload(); }
    </script>
</body>
</html>


